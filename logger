import os
import datetime
import awswrangler as wr

# Define the paths for the folders
input_folder = '/path/to/input/folder'
completed_folder = os.path.dirname(os.path.abspath(__file__))
log_folder = os.path.join(completed_folder, 'Log')

# Create the Log folder if it doesn't exist
if not os.path.exists(log_folder):
    os.makedirs(log_folder)

# Get the current date to add to the log filename
date_today = datetime.datetime.now().strftime("%Y-%m-%d")

# Create the log filename with the current date
log_filename = os.path.join(log_folder, f"{date_today}.log")

# Open the log file in append mode to add new runs
with open(log_filename, "a") as log_file:
    # Get a list of files in the input folder
    files = os.listdir(input_folder)
    
    # Loop through each file and create a table in AWS
    for file in files:
        try:
            # Create the table name from the file name
            table_name = os.path.splitext(file)[0]
            
            # Create the full path to the input file
            input_path = os.path.join(input_folder, file)
            
            # Create the full path to the completed file
            completed_path = os.path.join(completed_folder, file)
            
            # Create the table in AWS
            wr.s3.to_parquet(input_path, f"aws://my-bucket/{table_name}")
            
            # Move the file to the completed folder
            os.rename(input_path, completed_path)
            
            # Write to the log file that the table was created
            log_file.write(f"{table_name} table was created from {file}\n")
            
        except Exception as e:
            # Write to the log file that there was an error
            log_file.write(f"Error creating table from {file}: {e}\n")
            
            # Move the file back to the input folder
            os.rename(completed_path, input_path)
